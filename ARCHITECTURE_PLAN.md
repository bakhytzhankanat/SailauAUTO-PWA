# Sailau_avto PWA — Архитектура жоспары

Мобильді-бастамалы PWA, автосервис күнделікті жұмысы үшін.  
Бұл құжат: экран құрылымы, деректер моделі және ағындар бойынша ішкі сәйкестік жоспары.

---

## 1. Code reference және Screen reference

- **Code reference**: `code reference/` — Stitch-пен жасалған 22 HTML экран. Олар **визуалды/UI анықтамасы** ретінде қолданылады.
- **Screen reference**: Бөлек скриншоттар папкасы жоқ; код ішіндегі UI-дің өзі экран анықтамасы болып табылады.

### Code reference экрандарының картасы

| Файл | Экран аты (EN) | Қазақша / Мақсаты |
|------|----------------|-------------------|
| code.html | Login | Кіру |
| code(1).html | Shift Close Report | Ауысымды жабу (КІРІСТЕР, төлем түрі, операциялық шығын, қайырымдылық, жалақы бөлу, ауысымда кім болды) |
| code(2).html | Operational Settings | Баптаулар (рөлдер %, смена тогглар, жұмыс уақыты, Kaspi/қайырымдылық %, қызметтер/көлік каталогы) |
| code(3).html | Refined Shared Reminders | Ескертпелер (Барлығы/Белсенді/Орындалды, карточкалар, приоритет түстері) |
| code(4).html, code(21).html | Daily Service Calendar V2 | Күнтізбе: күн көрінісі, Бокс 1/2, сағат торы 10–18, жазба карточкалары, қоймаға қосу bottom sheet |
| code(5).html | Inventory Management | Қойма: іздеу, бөлшек тізімі, қалдық/мин. қалдық, Шығару/Қосу, модалдар |
| code(6).html | Add Booking - Note Step | Жазба қосу 6/6 — ескерту (міндетті емес) |
| code(7).html | Booking Summary Confirmation | Жазба қорытындысы / растау |
| code(8).html, code(9).html | Add Booking Service & Schedule | Жазба қосу: қызмет, бокс, уақыт пен ұзақтық |
| code(10).html | International Plate Input | Жазба: нөмір белгісі (халықаралық) |
| code(11).html | Add Booking Body Selection | Жазба: кузов таңдау |
| code(12).html | Add Booking Car Selection V2 | Жазба: көлік таңдау |
| code(13).html | Add Booking - Client Step V2 | Жазба: клиент (WhatsApp-тан соңғылар, барлық клиенттер) |
| code(14).html | Add Booking Client Step V1 | Жазба: WhatsApp клиенттері |
| code(15).html, code(16).html | Job Completed Success Summary | Жұмыс аяқталды — сәтті экран |
| code(17).html | Scrolled Payment and Parts Entry | Төлем енгізу: қызмет төлемі, төлем түрі, материал, сатылған бөлшектер |
| code(18).html | Finish Work Payment Entry | Төлем енгізу: төлем түрі (Қолма-қол, Карта, Kaspi, Аударым), материал, бөлшек қосу |
| code(19).html | Work In Progress Details | Жұмыс үстінде: таймер, клиент/көлік, қызметтер, «Жұмысты аяқтау» |
| code(20).html | Active Booking Details Start Work | Тапсырыс мәліметі: клиент, көлік, қызметтер, кесте, «Жұмысты бастау» |

**Есеп (Analytics)** және **WhatsApp кіріс жәшігі** (вебхук тізімі) экрандары code reference-та жоқ; олар талаптар бойынша құрылады.

---

## 2. Экран құрылымы (Screen structure)

### 2.1 Аутентификация

- **Login** — телефон, құпия сөз; «Кіру». Тіл: қарапайым қазақ.

### 2.2 Негізгі навигация (Bottom bar, барлық рөлдерде ортақ)

Барлық қатысушылар күнделікті экрандарға бірдей төменгі навигация арқылы кіреді:

1. **Күнтізбе** — күн/апта көрінісі, бокстар бойынша жазбалар.
2. **Жазба қосу** — жылдам жазба қосу (многокадамды визард).
3. **Қойма** — бөлшектер тізімі, қалдық, қосу/шығару.
4. **Ескертпелер** — белсенді/орындалған ескертпелер.
5. **Баптаулар** — рөл бойынша шектеулі (тек Иесі көрсе толық).

Рөлдер бойынша көрінетін тармақтар мен әрекеттер 3-бөлімде.

### 2.3 Күнтізбе (Calendar)

- **Күн көрінісі**: сағаттық тор (10:00–18:00), 60 мин қадам; сол жақта уақыт, үстінде «Бокс 1» / «Бокс 2» бағандары.
- **Апта көрінісі**: Дүйсен–Жексен тор (талап бойынша).
- Жазба карточкасы: уақыт аралығы, көлік, клиент, телефон, нөмір белгісі, қызметтер қысқаша, тағайындалған шебер, **статус түсі** (Жоспарланған / Келді / Жұмыста / Аяқталды / Болмады).
- Уақытты өзгерту: **тек қолмен қайта жоспарлау** (drag-and-drop жоқ).
- «Қазір» сызығы (опциялы): ағымдағы уақыт индикаторы.
- Күнтізбе ішіндегі модал: «Қоймаға қосу» (бөлшек + саны) — code(4) bottom sheet.

### 2.4 Жазба қосу (Add Booking) — көп қадамды визард

Тізбе (code reference сәйкес + талаптар):

1. **Клиент**: WhatsApp-тан соңғылар + «Барлық клиенттер» / жаңа (аты, телефон); көзі: WhatsApp / Live.
2. **Көлік**: каталогтан таңдау (мысалы Toyota Alphard, Estima, Camry 70).
3. **Кузов**: міндетті таңдау (мысалы 20 кузов, жыл).
4. **Нөмір белгісі**: бос мәтін (халықаралық формат қолдауы).
5. **Қызмет және уақыт**: қызметтер таңдау (саны 1 немесе 2), **Бокс** (1 немесе 2), **күн**, **басталу уақыты**, **ұзақтық** (қолмен).
6. **Ескерту**: міндетті емес ескерту өрісі.
7. **Қорытынды**: растау, сақтау.

Шек: жұмыс уақыты 10:00–18:00; жазба осы аралықта болуы керек. Бөлшектер жазба кезінде қосылмайды.

### 2.5 Жазба мәліметі / Жұмыс ағындары (Worker)

- **Тапсырыс мәліметі** (Жоспарланған/Келді): клиент, көлік, нөмір белгісі, қызметтер, кесте, шебер. Әрекет: **«Жұмысты бастау»**.
- **Жұмыс үстінде**: таймер (өткен уақыт), клиент/көлік, орындалып жатқан қызметтер. Әрекет: **«Жұмысты аяқтау»**.
- **Төлем енгізу**: қызмет төлемі (сома), төлем түрі — **KaspiPay** / **Қолма-қол** / **Аралас** (жасырын кө advanced); материал шығыны (бір сан); сатылған бөлшектер (тізімнен таңдау, саны, бағасы автомат).
- **Жұмыс аяқталды**: сәтті экран (code 15/16).

Клиент профилі: **тек жұмыс аяқталғаннан кейін** автоматты түрде жасалады (аты, телефон, көлік, визит тарихы, орындалған қызметтер, кепілдік 3 ай — қызмет бойынша шебер белгілейді).

### 2.6 Ауысымды жабу (Күнді жабу)

- **Кім жабады**: Аға жұмысшы немесе Иесі (резерв).
- **Күн таңдау**: күнтізбе күні бойынша.
- **Есептеу** (code(1) сәйкес):
  - Кірістер: Қызмет кассасы, Бөлшек сатылымы.
  - Шығарылудар: Материал шығыны, Түскі ас, Транспорт, Аренда.
  - Таза қызмет кірісі = қызмет + бөлшек − материал.
  - KaspiPay салығы: 4% тек Kaspi сомасынан.
  - Аралық сомадан кейін: **Қайырымдылық 10%** (жақын 1000-ға дөңгелектеу).
  - Қалғаннан: Менеджер 8%, содан кейін 60% шеберлерге / 40% иесіне; шеберлер үлесі — ауысымда «болды» деп белгіленгендер арасында тең бөлінеді.
  - Бөлшек сатылымы жалақы пулына енбейді, тек иесі дивидендтеріне.
- UI: түстер мен блоктар code(1).html бойынша; «Ауысымды жабу» түймесі; күнді өзгерту мүмкіндігі бар, бірақ UI-да ыңғайсыз етіп беру (редакцияны азайту).

### 2.7 Қойма (Inventory)

- Тізім: бөлшек аты, сату бағасы, қалдық (және мин. қалдық — «Аз қалды» ескертуі).
- **Қосу/шығару**: тек Иесі/Менеджер жаңа бөлшек түрін қосады; санын өзгерту — қосу/шығару (code(5): Қосу модалы, Шығару — long-press немесе түйме).
- Жұмысшы жұмысты аяқтағанда: сатылған бөлшек тізімнен таңдалады, саны және (авто) баға; қойма қалдығы азаяды, PART SALES жазылады.

### 2.8 Ескертпелер (Reminders)

- Фильтр: Барлығы / Белсенді / Орындалды.
- Карточка: тақырып, приоритет (түс: қызыл/қызғылт сары/жасыл), кім қойған (Мастер/Админ), уақыт; «Қоймаға өту» т.б. әрекеттер.
- Тексеру: Иесі/Менеджер/Жұмысшы рөлдері бойынша көрсету/редакциялау ережелері.

### 2.9 Баптаулар (Settings) — Иесі

- Қызметкерлер және рөлдер: Менеджер %, Мастерлер %, Иесі % (жиыны 100% болуы керек).
- Ауысым (Смена): тізімдегі адамдардың «ауысымда болды» тогглары.
- Жұмыс уақыты: басталу/аяқталу (10:00 / 18:00), бокс саны (2).
- Қаржылық: KaspiPay %, Қайырымдылық %, 1000-ға дөңгелектеу.
- Қызметтер анықтамалығы: категориялар (Есік қызметтері, Қосымша, Пеш т.б.) — редакция.
- Көлік каталогы: марка/модель/кузов т.б. — редакция.
- Мастер тізімін редакциялау (тек Иесі).

### 2.10 Есеп (Analytics) — Иесі

- Кезең: Күн / Апта (Дүй–Жек) / Ай.
- Көрсеткіштер: Қызмет түсімі, Запчасть сатылымы, Материал шығыны, Таза табыс, Орташа чек, Орташа күндік түсім, Көлік саны, Еңбекақы есебі, Иесі дивидендтері.
- Code reference-та экран жоқ; UI қарапайым қазақ тілінде, мобильді карточкалар/кесте түрінде жасалады.

### 2.11 Бухгалтерия — Иесі

Қаржылық есептер, калькуляциялар (талаптар бойынша нақты экрандар кейін детальданады).

### 2.12 WhatsApp интеграциясы

- Кіріс: Chatflow вебхукі. Қолданбада: **WhatsApp кіріс** экраны (тізім).
- Әр элемент: телефон, аты (бар болса), соңғы хабарлама; **«Жазба қосу»** түймесі — осы контактпен «Жазба қосу» визарды ашады; клиент **сервисте қызмет көрсетілгенше** жасалмайды (тек жазба/визит арқылы).

### 2.13 Worker-ге арналған экстра

- **Ауысымды бастау**: жұмысшы «смена басталды» деп белгілейді (рөл/логика бойынша).
- Күнтізбе: Worker күнтізбені **бокс бойынша** көреді (бар болса бокс таңдау фильтрі).
- Күнді жабу: тек Аға жұмысшы немесе Иесі.

---

## 3. Рөлдер бойынша қол жетімділік

| Функция / Экран | Иесі | Менеджер | Жұмысшы |
|-----------------|------|----------|---------|
| Күнтізбе | ✓ | ✓ | ✓ (бокс бойынша) |
| Жазба қосу | ✓ | ✓ (құру/редакция) | — |
| Қойма көру | ✓ | ✓ | ✓ |
| Қойма: жаңа бөлшек/өшіру | ✓ | ✓ | — |
| Ескертпелер | ✓ | ✓ | ✓ |
| Есеп (Analytics) | ✓ | — | — |
| Бухгалтерия | ✓ | — | — |
| Баптаулар | ✓ (толық) | — | — |
| Мастер тізімі редакция | ✓ | — | — |
| Қызмет/көлік каталогтары | ✓ | — | — |
| Жұмысты бастау/аяқтау, төлем енгізу | ✓ | — | ✓ |
| Күнді жабу | ✓ (резерв) | — | ✓ (Аға жұмысшы) |
| WhatsApp тізімі + «Жазба қосу» | ✓ | ✓ | — (немесе рөлге байланысты) |

---

## 4. Деректер моделі (Data model) — негізгі сущностьтар

### 4.1 Пайдаланушылар және рөлдер

- **User**: id, phone, passwordHash, role (owner | manager | worker), displayName, isSeniorWorker? (күнді жабу үшін).
- **Session**: логин/логаут, PWA сессиясы.

### 4.2 Клиенттер және көліктер

- **Client**: id, name, phone, source (whatsapp | live), createdAt. (Профиль «визит аяқталғаннан кейін» толықтырылады.)
- **VehicleCatalog**: id, name (мысалы Toyota Alphard), bodyType (міндетті), year? — Иесі редакциялайды.
- **ClientVehicle**: clientId, vehicleCatalogId, plateNumber? (еркін мәтін).

### 4.3 Жазбалар (Bookings)

- **Booking**: id, clientId?, clientName (міндетті), phone, source (whatsapp | live), vehicleCatalogId, bodyType (міндетті), plateNumber?, boxId (1 | 2), date, startTime, endTime (немесе durationMinutes), status (planned | arrived | in_progress | completed | no_show), assignedMasterId?, note?, createdAt, updatedAt.
- **BookingService**: bookingId, serviceCatalogId, quantity (1 немесе 2).
- **ServiceCatalog**: id, name, categoryId — Баптауларда Иесі басқарады.

Статус түстері: planned — көк, arrived — қызғылт сары, in_progress — сары, completed — жасыл, no_show — сұр/қызыл (UI-да бірдей келісім).

### 4.4 Жұмыс және төлем

- **Job** (немесе Booking-ты status арқылы басқару): bookingId, startedAt, completedAt?, servicePaymentAmount?, paymentType (kaspipay | cash | mixed), materialExpense?, kaspiTaxAmount?.
- **JobPartSale**: jobId, inventoryItemId, quantity, unitPrice; қойма қалдығы азаяды, PART SALES жазбасы.
- **Warranty**: clientId, serviceCatalogId, completedAt, expiresAt (3 ай); шебер қызмет бойынша белгілейді.

### 4.5 Қойма

- **InventoryItem**: id, name, sku?, salePrice, quantity, minQuantity?, unit (дана т.б.); Owner/Manager қосады/өшіреді.
- **InventoryMovement**: itemId, type (in | out | sale), quantity, amount?, refType (job | manual), refId, createdAt.

### 4.6 Ауысым жабу

- **DayClose**: id, date, closedById, closedAt; KaspiPay/Cash сомалары, материал, түскі ас, транспорт, аренда; қайырымдылық (10%, 1000-ға); менеджер %, шеберлер %; «ауысымда болды» мастер тізімі; есептелген сомалар (менеджер, әр шебер, иесі); бөлшек сатылымы иесі дивидендіне жеке.
- **DayCloseMaster**: dayCloseId, userId, shareAmount.

### 4.7 Ескертпелер

- **Reminder**: id, title, priority (high | medium | low), createdById?, assigneeId?, status (active | done), dueAt?, linkType? (inventory), linkId?, createdAt.

### 4.8 WhatsApp вебхук

- **WhatsAppInbound**: id, phone, name?, lastMessage, lastMessageAt, createdAt — вебхуктан толтырылады; «Жазба қосу» басылғанда жазба визарды ашып, клиентті әлі жасамаймыз.

### 4.9 Баптаулар (конфиг)

- **Settings**: жеке ключ-значение немесе бір «config» объект: workingHoursStart, workingHoursEnd, boxCount, managerPercent, mastersPercent, ownerPercent, kaspiTaxPercent, charityPercent, roundCharityToNearest1000.
- **Master** (қызметкерлер тізімі): User-мен байланыс немесе жеке Master сущность; «ауысымда болды» — DayClose-та таңдау.

---

## 5. Негізгі ағындар (Flows)

### 5.1 Кіру

1. Login: phone + password → Session, role.
2. Рөл бойынша: bottom bar тармақтары мен экрандар көрсетіледі (мысалы Баптауларда тек Иесі толық көреді).

### 5.2 Жазба қосу (Manager/Owner)

1. Күнтізбе немесе «Жазба қосу» → визард.
2. Клиент (WhatsApp соңғылар / барлық / жаңа) → Көлік → Кузов → Нөмір белгісі → Қызметтер + Бокс + Күн + Уақыт + ұзақтық → Ескерту → Қорытынды → Сақтау.
3. Валидация: 10:00–18:00, бокс конфликті жоқ.

### 5.3 Жұмысты орындау (Worker)

1. Күнтізбе: жазба карточкасы → Тапсырыс мәліметі → «Жұмысты бастау» → status = in_progress, startedAt.
2. «Жұмыс үстінде» экраны: таймер, «Жұмысты аяқтау» → Төлем енгізу (қызмет сомасы, Kaspi/Қолма-қол/Аралас, материал, бөлшектер) → Сақтау → status = completed; клиент профилі жасалу/жаңартылу, кепілдік (таңдалған қызметтерге 3 ай).
3. Қойма: сатылған бөлшектер бойынша қалдық азаю, PartSale жазбалары.

### 5.4 Күнді жабу

1. Баптаулар немесе арнайы «Ауысымды жабу» тармағы (рөл: Аға жұмысшы / Иесі).
2. Күн таңдау → Кірістер/шығындар автомат (жобалар бойынша) + қолмен түзету → Kaspi 4% → Қайырымдылық 10% (1000-ға) → Бөліну кестесі (менеджер 8%, шеберлер, иесі) → «Ауысымда кім болды» тогглар → «Ауысымды жабу» → DayClose сақтау.
3. Бөлшек сатылымы жалақы есебіне енбейді, иесі дивидендіне енеді.

### 5.5 WhatsApp

1. Вебхук: жаңа/жаңартылған чат → WhatsAppInbound жазады.
2. Қолданба: WhatsApp тізімі → «Жазба қосу» → визард телефон/атымен ашылады; клиент сервисте қызмет көргенше жүйеде толық клиент ретінде жасалмайды.

---

## 6. UI/UX және дизайн жүйесі (Code reference негізінде)

- **Түстер**: primary `#30867b`, bg-main `#0F0F0F`, card-bg `#1C1C1C`, border `#2A2A2A`, text-muted `#9E9E9E`; статус: planned, reached, progress, completed (code(4)); reminder: danger, warning, success.
- **Шрифт**: Inter.
- **Компоненттер**: дөңгелек түймелер, rounded-xl карточкалар, Material Symbols Outlined.
- **Мобильді**: 100dvh min-height, pb-safe (safe-area), hide-scroll, touch-manipulation; long-press қоймада «шығару» үшін.
- **Тіл**: барлық интерфейс **қарапайым қазақ** (механиктердің күнделікті тілі); формальды сөздерден аулақ.

---

## 7. Техникалық ұсыныстар (реализация үшін)

- **Стек**: React/Vue/Svelte + PWA (service worker, manifest); мобильді бірінші, RWD.
- **Маршрутизация**: /login, /calendar, /booking/add, /booking/:id, /inventory, /reminders, /settings, /analytics, /day-close, /whatsapp (рөл бойынша guard).
- **State**: глобал store (auth, role, selectedDate); визард state (жазба қосу); күнтізбе деректері кеш + сервер.
- **API слой**: REST немесе GraphQL; Bookings, Clients, Inventory, DayClose, Settings, WhatsAppInbound, Reminders, Analytics (агрегаттар).
- **Офлайн**: күнтізбе/қойма/ескертпелер үшін шектеулі офлайн кеш (кейін қарастыру).
- **Вебхук**: WhatsApp Chatflow → backend endpoint → WhatsAppInbound жазу; PWA деректерді API арқылы алады.

Бұл жоспар код жазуға кіріспейді; ол экрандар, деректер және ағындар бойынша бір сәйкес келісім ретінде пайдаланылады және code reference папкасымен бірге Sailau_avto PWA-ны іске асыруға негіз болады.
